<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Pong</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            background-color: dimgrey;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 0 },
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    },
    audio: {
        disableWebAudio: true,
    }
};

var sound_paddle;
var sound_wall;
var sound_score;
var delay = 2000;
var MAX = 0;
var bombs;
var cursors;
var score = 0;
var gameOver = false;
var scoreText;
var playerOne;
var playerTwo;
var p1velocity;
var ballvelocity;
var ballposition;
var bomb;
var ballSpeed = 400;
var playerOneScore;
var playerTwoScore;
var p1Score = 0;
var p2Score = 0;
var net;
var blip;
var MAXBALLVELOCITY_X = 0;
var MAXBALLVELOCITY_Y = 0;
var ball_vx_max;
var ball_vy_max;
var MAX_ALLOWED_SPEED = 900;
var ball_pos_y_min = 100;
var ball_pos_y_max = 0;
var ball_pos_y_min_text;
var ball_pos_y_max_text;

var game = new Phaser.Game(config);

function preload ()
{
    this.load.image('bar', 'assets/pong-small.png');
    this.load.image('sky', 'assets/pong-bg.png');
    this.load.image('bomb', 'assets/ball.png');
    this.load.image('net', 'assets/net5.png');
    this.load.audio('blip-paddle', 'assets/blip-paddle.wav', {instances: 1});
    this.load.audio('blip-wall', 'assets/blip-wall.wav', {instances: 1});
    this.load.audio('blip-score', 'assets/blip-score.wav', {instances: 1});
}

function create ()
{
    this.add.image(400, 300, 'sky'); // Background

    playerOne = this.physics.add.image(50, 300, 'bar');
    playerOne.setCollideWorldBounds(true);
    playerOne.setImmovable(true);

    playerTwo = this.physics.add.image(750, 300, 'bar');
    playerTwo.setCollideWorldBounds(true);
    playerTwo.setImmovable(true);

    bombs = this.physics.add.group();

    bomb = bombs.create(400, Phaser.Math.Between(0, 600), 'bomb');
    //bomb = bombs.create(400, 300, 'bomb');
    bomb.setBounce(1);
    bomb.setCollideWorldBounds(true);
    bomb.setVelocity(-ballSpeed, Phaser.Math.Between(0, 400));
    //bomb.setVelocity(-ballSpeed, 0);
    bomb.allowGravity = false;

    cursors = this.input.keyboard.createCursorKeys(); // Keyboard inputs

    // The net
    this.add.image(400, 300, 'net');

    // Sound
    // this.sound.add('blip-paddle');
    // this.sound.add('blip-wall');
    // this.sound.add('blip-score');
    sound_paddle = this.sound.add('blip-paddle');
    sound_wall = this.sound.add('blip-wall');
    sound_score = this.sound.add('blip-score');

    //  The score
    //scoreText = this.add.text(300, 0, 'score: 0', { fontSize: '32px', fill: '#f9f9fa' });
    playerOneScore = this.add.text(200, 50, '0', { fontSize: '64px', fill: '#f9f9fa' });
    playerTwoScore = this.add.text(600, 50, '0', { fontSize: '64px', fill: '#f9f9fa' });

    // Debug data
    //p1velocity = this.add.text(0, 0, 'p1 vel: ', { fontSize: '12px', fill: '#f9f9fa' });
    //ballvelocity = this.add.text(0, 20, 'ball vel: ', { fontSize: '12px', fill: '#f9f9fa' });
    //ballposition = this.add.text(0, 40, 'ball pos: ', { fontSize: '12px', fill: '#f9f9fa' });
    //localMax = this.add.text(0, 60, 'x max: ', { fontSize: '12px', fill: '#f9f9fa' });
    //ball_vx_max = this.add.text(0, 60, 'vx max: ', { fontSize: '12px', fill: '#f9f9fa' });
    //ball_vy_max = this.add.text(0, 80, 'vy max: ', { fontSize: '12px', fill: '#f9f9fa' });
    //ball_pos_y_min_text = this.add.text(0, 40, 'ball y min: ', { fontSize: '12px', fill: '#f9f9fa' });
    //ball_pos_y_max_text = this.add.text(0, 80, 'ball y max: ', { fontSize: '12px', fill: '#f9f9fa' });

    //  Collisions
    this.physics.add.collider(bomb, playerOne, hitplayerOne, null, this);
    this.physics.add.collider(bomb, playerTwo, hitplayerTwo, null, this);
}

function update ()
{
    // if (bomb.body.position.x > MAX) {
    //     MAX = bomb.body.position.x;
    // }

    // localMax.setText('x max: ' + MAX); 

    if (p1Score === 5 || p2Score === 5) {
        this.physics.pause();
        bomb.x = 400;
        bomb.y = 300;
        return;
    }

    if (bomb.body.position.y === 0 || bomb.body.position.y === 590) {
        this.sound.play('blip-wall');
    }

    // AI opponent
    if (bomb.body.position.y < playerTwo.body.position.y) {
        playerTwo.setVelocityY(-400);
    } else if (bomb.body.position.y > playerTwo.body.position.y) {
        playerTwo.setVelocityY(400);
    } else {
        playerTwo.setVelocity(0);
    }

    // Code for AI to play itself
    // if (bomb.body.position.y < playerOne.body.position.y) {
    //     playerOne.setVelocityY(-400);
    // } else if (bomb.body.position.y > playerOne.body.position.y) {
    //     playerOne.setVelocityY(400);
    // } else {
    //     playerOne.setVelocity(0);
    // }

    if (bomb.body.position.x === 0) {
        this.sound.play('blip-score');
        bomb.x = 10;
        bomb.y = 300;
        bomb.setTint(0x000000);
        bomb.setVelocity(0, 0);
        playerTwoScore.setText('' + (++p2Score));
        setTimeout(() => {
            bomb.setTint(0xffffff);
            bomb.x = 400;
            bomb.y = Phaser.Math.Between(0, 600);
            ballSpeed = 400;
            bomb.setVelocity(-ballSpeed, Phaser.Math.Between(0, 400));
        }, delay);
    }

    if (bomb.body.position.x === 790) {
        this.sound.play('blip-score');
        bomb.x = 780;
        bomb.y = 300;
        bomb.setTint(0x000000);
        bomb.setVelocity(0, 0);
        playerOneScore.setText('' + (++p1Score));
        setTimeout(() => {
            bomb.setTint(0xffffff);
            bomb.x = 400;
            bomb.y = Phaser.Math.Between(0, 600);
            ballSpeed = 400;
            bomb.setVelocity(ballSpeed, Phaser.Math.Between(0, 400));
        }, delay);
    }

    //p1velocity.setText('p1 vel: ' + playerOne.body.velocity.y);
    //ballvelocity.setText('ball vel x: ' + bomb.body.velocity.x + ' y: ' + bomb.body.velocity.y);
    //ballposition.setText('ball pos x: ' + bomb.body.position.x + ' y: ' + bomb.body.position.y);
    //ball_vx_max.setText('vx max: ' + MAXBALLVELOCITY_X);
    //ball_vy_max.setText('vy max: ' + MAXBALLVELOCITY_Y);
    //ball_pos_y_min_text.setText('min ball y: ' + ball_pos_y_min);
    //ball_pos_y_max_text.setText('max ball y: ' + ball_pos_y_max);


    if (bomb.body.velocity.x > MAXBALLVELOCITY_X) {
        MAXBALLVELOCITY_X = bomb.body.velocity.x;
    }

    if (bomb.body.velocity.y > MAXBALLVELOCITY_Y) {
        MAXBALLVELOCITY_Y = bomb.body.velocity.y;
    }

    if (bomb.body.position.y < ball_pos_y_min) {
        ball_pos_y_min = bomb.body.position.y;
    }

    if (bomb.body.position.y > ball_pos_y_max) {
        ball_pos_y_max = bomb.body.position.y;
    }

    // Human player input
    if (cursors.up.isDown) {
        playerOne.setVelocityY(-600);
    } else if (cursors.down.isDown) {
        playerOne.setVelocityY(600);
    } else {
        playerOne.setVelocityY(0);
    }
}

function hitplayerOne(bomb, playerOne) {
    // testing
    //this.sound.setVolume(0.25);
    //this.sound.play('blip'[0]);
    sound_paddle.play();
    //blip.play();
    //ballSpeed += 75;
    ballSpeed = (ballSpeed + 75) > MAX_ALLOWED_SPEED ? MAX_ALLOWED_SPEED : ballSpeed + 75;

    var paddle1Y = playerOne.body.position.y;
    var PADDLEHEIGHT = 50;
    var intersectY = bomb.body.position.y;
    var MAXBOUNCEANGLE = 2 * Math.PI/12;

    var relativeIntersectY = (paddle1Y+(PADDLEHEIGHT/2)) - intersectY;
    var normalizedRelativeIntersectionY = (relativeIntersectY/(PADDLEHEIGHT/2));
    var bounceAngle = normalizedRelativeIntersectionY * MAXBOUNCEANGLE;

    var ballVx = ballSpeed*Math.cos(bounceAngle);
    var ballVy = ballSpeed*-Math.sin(bounceAngle);

    bomb.setVelocity(ballVx, ballVy);
}

function hitplayerTwo(bomb, playerTwo) {
    this.sound.play('blip-paddle');
    //ballSpeed += 75;
    ballSpeed = (ballSpeed + 75) > MAX_ALLOWED_SPEED ? MAX_ALLOWED_SPEED : ballSpeed + 75;
    var paddle2Y = playerTwo.body.position.y;
    var PADDLEHEIGHT = 50;
    var intersectY = bomb.body.position.y;
    var MAXBOUNCEANGLE = 2 * Math.PI/12;

    var relativeIntersectY = (paddle2Y+(PADDLEHEIGHT/2)) - intersectY;
    var normalizedRelativeIntersectionY = (relativeIntersectY/(PADDLEHEIGHT/2));
    var bounceAngle = normalizedRelativeIntersectionY * MAXBOUNCEANGLE;

    var ballVx = -ballSpeed*Math.cos(bounceAngle);
    var ballVy = ballSpeed*-Math.sin(bounceAngle);

    bomb.setVelocity(ballVx, ballVy);
}

</script>

</body>
</html>